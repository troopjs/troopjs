<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='global-property-'>/**
</span> * @license MIT http://troopjs.mit-license.org/
 */
define([
  &quot;troopjs-core/component/emitter&quot;,
  &quot;./config&quot;,
  &quot;./emitter&quot;,
  &quot;when/when&quot;
], function (Emitter, config, emitter, when) {
  &quot;use strict&quot;;

<span id='hub-component'>  /**
</span>   * Component that provides hub features.
   * @class hub.component
   * @extend core.component.emitter
   * @mixin hub.config
   * @alias feature.component
   */

  var UNDEFINED;
  var NULL = null;
  var TRUE = true;
  var DATA = config.emitter.data;
  var ARGS = &quot;args&quot;;
  var NAME = &quot;name&quot;;
  var TYPE = &quot;type&quot;;
  var VALUE = &quot;value&quot;;
  var HUB = &quot;hub&quot;;
  var RE = new RegExp(&quot;^&quot; + HUB + &quot;/(.+)&quot;);

<span id='hub-component-handler-sig-start'>  /**
</span>   * @handler sig/start
   * @localdoc Triggers memorized values on HUB specials
   * @inheritdoc
   */

<span id='hub-component-handler-sig-added'>  /**
</span>   * @handler sig/added
   * @localdoc Registers subscription on the {@link hub.emitter hub emitter} for matching callbacks
   * @inheritdoc #event-sig/added
   */

<span id='hub-component-handler-sig-removed'>  /**
</span>   * @handler sig/removed
   * @localdoc Removes remote subscription from the {@link hub.emitter hub emitter} that was previously registered in {@link #handler-sig/added}
   * @inheritdoc #event-sig/removed
   */

<span id='hub-component-method-constructor'>  /**
</span>   * @method constructor
   * @inheritdoc
   */
  return Emitter.extend(function () {
    var me = this;
    var memorized = [];

    // Intercept added handlers
    me.on(&quot;sig/added&quot;, function (handlers, handler) {
      var _empty = {};
      var _matches;
      var _type;
      var _memory;

      // If we've added a HUB handler ...
      if ((_matches = RE.exec(handler[TYPE])) !== NULL) {
        // Let `_type` be `_matches[1]`
        _type = _matches[1];

        // Let `handler[HUB]` be `_type`
        handler[HUB] = _type;

        // Subscribe to the hub
        emitter.on(_type, handler);

        // If re-emit was requested ...
        if (handler[DATA] === TRUE) {
          // If memorization is &quot;open&quot;
          if (memorized !== UNDEFINED) {
            memorized.push(handler);
          }
          // .. otherwise try to `emit` if `emitter` memory for `_type` is not `_empty`
          else if ((_memory = emitter.peek(_type, _empty)) !== _empty) {
            me.emit.apply(me, [ handler ].concat(_memory));
          }
        }
      }
    });

    // Intercept removed handlers
    me.on(&quot;sig/removed&quot;, function (handlers, handler) {
      var _matches;

      // If we've removed a HUB callback ...
      if ((_matches = RE.exec(handler[TYPE])) !== NULL) {

        // Unsubscribe from the hub
        emitter.off(_matches[1], handler);

        // If re-emit was requested and there are `memorized` callbacks ...
        if (handler[DATA] === TRUE &amp;&amp; memorized !== UNDEFINED) {
          // TODO in place filtering for performance
          // Filter matching `_handler`
          memorized = memorized.filter(function (_handler) {
            return _handler !== handler;
          });
        }
      }
    });

    // Intercept component start
    me.on(&quot;sig/start&quot;, function () {
      return when
        // Map `memorized` ...
        .map(memorized, function (_handler) {
          var _memory;
          var _empty = {};

          // If `emitter` memory for `_handler[HUB]` is not `_empty` re-emit ...
          return (_memory = emitter.peek(_handler[HUB], _empty)) !== _empty
            ? me.emit.apply(me, [ _handler ].concat(_memory))
            : UNDEFINED;
        })
        // ... and reset to `UNDEFINED`
        .tap(function () {
          memorized = UNDEFINED;
        });
    });

  }, {
    &quot;displayName&quot;: &quot;hub/component&quot;,

<span id='hub-component-handler-sig-initialize'>    /**
</span>     * @inheritdoc
     * @localdoc Registers event handlers declared HUB specials
     * @handler
     */
    &quot;sig/initialize&quot;: function () {
      var me = this;
      var specials = me.constructor.specials;

      if (specials.hasOwnProperty(HUB)) {
        specials[HUB].forEach(function (special) {
          me.on(special[NAME], special[VALUE], special[ARGS][0]);
        });
      }
    }
  });
});
</pre>
</body>
</html>
